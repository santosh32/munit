<?xml version="1.0" encoding="UTF-8"?>


<!--


 Tests that include the usage of the mclient for transport calls


-->
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:spring="http://www.springframework.org/schema/beans"
      xmlns:mulemock="http://www.mulesoft.org/schema/mule/mock"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:ftpserver="http://www.mulesoft.org/schema/mule/ftpserver"
      xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd

        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.2/mule.xsd
        http://www.mulesoft.org/schema/mule/mock http://www.mulesoft.org/schema/mule/mock/1.0/mule-mock.xsd
        http://www.mulesoft.org/schema/mule/ftpserver http://www.mulesoft.org/schema/mule/ftpserver/1.0/mule-ftpserver.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/1.0/mule-munit.xsd">

    <spring:beans>
        <spring:import resource="mule-config.xml"/>
        <spring:import resource="common-definitions.xml" />
    </spring:beans>


    <munit:config mock-inbounds="false"/>
    <ftpserver:config port="3001" secure="true" name="sftpServer"/>
    <ftpserver:config port="3002" name="ftpServer"/>
    <mulemock:config of="Salesforce" name="salesforceMock"/>

    <munit:before-suite name="before.suite"
          description="Starting FTP server">
        <ftpserver:start-server config-ref="sftpServer"/>
        <ftpserver:start-server config-ref="ftpServer"/>
    </munit:before-suite>

    <munit:before-test name="before.each.test"
         description="Reseting mocks...">
        <mulemock:reset config-ref="salesforceMock"/>
    </munit:before-test>


    <munit:after-suite name="after.suite"
          description="Stopping FTP server">
        <ftpserver:stop-server config-ref="sftpServer"/>
        <ftpserver:stop-server config-ref="ftpServer"/>
    </munit:after-suite>

    <munit:test name="testThatSalesforceQueryIsStoredInTheSFTPServer"

          description="
        Salesforce query response must be stored in the sftp server">

        <mulemock:expect config-ref="salesforceMock" when="query" mustReturn-ref="nonEmptyList">
            <mulemock:parameters>
                <mulemock:parameter value-ref="salesforceQuery"/>
            </mulemock:parameters>
        </mulemock:expect>


        <flow-ref name="sendToSFTP" />

         <ftpserver:contains-files file="sftp-jsonResult.txt" path="/tmp" config-ref="sftpServer"/>

    </munit:test>


    <munit:test name="testThatSalesforceQueryIsStoredInTheFTPServer"

          description="
        Salesforce query response must be stored in the ftp server">

        <mulemock:expect config-ref="salesforceMock" when="query" mustReturn-ref="nonEmptyList"/>


        <flow-ref name="sendToFTP" />

        <ftpserver:contains-files file="ftp-jsonResult.txt" path="/tmp" config-ref="ftpServer"/>

    </munit:test>

</mule>